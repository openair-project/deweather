<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Build a Deweather Model ‚Äî build_dw_model ‚Ä¢ deweather</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Nunito_Sans-0.4.10/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Build a Deweather Model ‚Äî build_dw_model"><meta name="description" content="This function builds a 'deweathering' machine learning model with useful
methods for interrogating it in an air quality and meteorological context. It
uses any number of variables (most usefully meteorological variables like
wind speed and wind direction and temporal variables defined in
append_dw_vars()) to fit a model predicting a given pollutant. While
these models are useful for 'removing' the effects of meteorology from an air
quality time series (e.g., through simulate_dw_met()), they are also useful
for explanatory analysis (e.g., through plot_dw_partial_1d())."><meta property="og:description" content="This function builds a 'deweathering' machine learning model with useful
methods for interrogating it in an air quality and meteorological context. It
uses any number of variables (most usefully meteorological variables like
wind speed and wind direction and temporal variables defined in
append_dw_vars()) to fit a model predicting a given pollutant. While
these models are useful for 'removing' the effects of meteorology from an air
quality time series (e.g., through simulate_dw_met()), they are also useful
for explanatory analysis (e.g., through plot_dw_partial_1d())."><meta property="og:image" content="https://openair-project.github.io/deweather/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">deweather</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/deweather.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Parameter-Mapping.html">Hyperparameter Cheat Sheet</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-case-studies-external-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Case Studies (External)</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-case-studies-external-"><li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/pii/S004896971834244X">(2019) Using meteorological normalisation to detect interventions in air quality time series</a></li>
    <li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/abs/pii/S1352231012001355">(2012) A short-term intervention study ‚Äî Impact of airport closure due to the eruption of Eyjafjallaj√∂kull on near-field air quality</a></li>
    <li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/abs/pii/S1352231009003069">(2009) Analysis of air pollution data at a mixed source location using boosted regression trees</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openair-project" aria-label="Website"><span class="fa fa-globe"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://openair-project.github.io/book/" aria-label="Book"><span class="fa fa-book"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openair-project/deweather/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-packages"><li><h6 class="dropdown-header" data-toc-skip>Data Analysis</h6></li>
    <li><a class="external-link dropdown-item" href="https://openair-project.github.io/openair/">üß≠ openair</a></li>
    <li><a class="external-link dropdown-item" href="https://openair-project.github.io/openairmaps/">üó∫Ô∏è openairmaps</a></li>
    <li><a class="dropdown-item" href="https://openair-project.github.io/deweather/">üìâ deweather</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Data Access</h6></li>
    <li><a class="external-link dropdown-item" href="https://openair-project.github.io/worldmet/">üçÉ worldmet</a></li>
    <li><a class="external-link dropdown-item" href="https://openair-project.github.io/euroaq/">üåç euroaq</a></li>
    <li><a class="external-link dropdown-item" href="https://openair-project.github.io/ukaq/">üëë ukaq</a></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Build a Deweather Model</h1>
      <small class="dont-index">Source: <a href="https://github.com/openair-project/deweather/blob/main/R/build_dw_model.R" class="external-link"><code>R/build_dw_model.R</code></a></small>
      <div class="d-none name"><code>build_dw_model.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function builds a 'deweathering' machine learning model with useful
methods for interrogating it in an air quality and meteorological context. It
uses any number of variables (most usefully meteorological variables like
wind speed and wind direction and temporal variables defined in
<code><a href="append_dw_vars.html">append_dw_vars()</a></code>) to fit a model predicting a given <code>pollutant</code>. While
these models are useful for 'removing' the effects of meteorology from an air
quality time series (e.g., through <code><a href="simulate_dw_met.html">simulate_dw_met()</a></code>), they are also useful
for explanatory analysis (e.g., through <code><a href="plot_dw_partial_1d.html">plot_dw_partial_1d()</a></code>).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">build_dw_model</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">pollutant</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"hour"</span>, <span class="st">"weekday"</span>, <span class="st">"air_temp"</span><span class="op">)</span>,</span>
<span>  tree_depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  trees <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  learn_rate <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  mtry <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>  loss_reduction <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  stop_iter <span class="op">=</span> <span class="fl">45L</span>,</span>
<span>  engine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"xgboost"</span>, <span class="st">"lightgbm"</span>, <span class="st">"ranger"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  .date <span class="op">=</span> <span class="st">"date"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>An input <code>data.frame</code> containing one pollutant column (defined
using <code>pollutant</code>) and a collection of feature columns (defined using
<code>vars</code>).</p></dd>


<dt id="arg-pollutant">pollutant<a class="anchor" aria-label="anchor" href="#arg-pollutant"></a></dt>
<dd><p>The name of the column (likely a pollutant) in <code>data</code> to
predict.</p></dd>


<dt id="arg-vars">vars<a class="anchor" aria-label="anchor" href="#arg-vars"></a></dt>
<dd><p>The name of the columns in <code>data</code> to use as model features -
i.e., to predict the values in the <code>pollutant</code> column. Any character
columns will be coerced to factors. <code>"hour"</code>, <code>"weekday"</code>, <code>"trend"</code>,
<code>"yday"</code>, <code>"week"</code>, and <code>"month"</code> are special terms and will be passed to
<code><a href="append_dw_vars.html">append_dw_vars()</a></code> if not present in <code>names(data)</code>.</p></dd>


<dt id="arg-tree-depth">tree_depth<a class="anchor" aria-label="anchor" href="#arg-tree-depth"></a></dt>
<dd><p>Tree Depth <code>&lt;xgboost|lightgbm&gt;</code></p>
<p>An integer for the maximum depth of the tree (i.e., number of splits).</p></dd>


<dt id="arg-trees">trees<a class="anchor" aria-label="anchor" href="#arg-trees"></a></dt>
<dd><p>Number of Trees <code>&lt;xgboost|lightgbm|ranger&gt;</code></p>
<p>An integer for the number of trees contained in the ensemble.</p></dd>


<dt id="arg-learn-rate">learn_rate<a class="anchor" aria-label="anchor" href="#arg-learn-rate"></a></dt>
<dd><p>Learning Rate <code>&lt;xgboost|lightgbm&gt;</code></p>
<p>A number for the rate at which the boosting algorithm adapts from
iteration-to-iteration. This is sometimes referred to as the shrinkage
parameter.</p></dd>


<dt id="arg-mtry">mtry<a class="anchor" aria-label="anchor" href="#arg-mtry"></a></dt>
<dd><p>Number of Randomly Selected Predictors
<code>&lt;xgboost|lightgbm|ranger&gt;</code></p>
<p>A number for the number (or proportion) of predictors that will be randomly
sampled at each split when creating the tree models.</p></dd>


<dt id="arg-min-n">min_n<a class="anchor" aria-label="anchor" href="#arg-min-n"></a></dt>
<dd><p>Minimal Node Size <code>&lt;xgboost|lightgbm|ranger&gt;</code></p>
<p>An integer for the minimum number of data points in a node that is required
for the node to be split further.</p></dd>


<dt id="arg-loss-reduction">loss_reduction<a class="anchor" aria-label="anchor" href="#arg-loss-reduction"></a></dt>
<dd><p>Minimum Loss Reduction <code>&lt;xgboost|lightgbm&gt;</code></p>
<p>A number for the reduction in the loss function required to split further.</p></dd>


<dt id="arg-sample-size">sample_size<a class="anchor" aria-label="anchor" href="#arg-sample-size"></a></dt>
<dd><p>Proportion Observations Sampled <code>&lt;xgboost&gt;</code></p>
<p>A number for the number (or proportion) of data that is exposed to the
fitting routine.</p></dd>


<dt id="arg-stop-iter">stop_iter<a class="anchor" aria-label="anchor" href="#arg-stop-iter"></a></dt>
<dd><p>Number of Iterations Before Stopping <code>&lt;xgboost&gt;</code></p>
<p>The number of iterations without improvement before stopping.</p></dd>


<dt id="arg-engine">engine<a class="anchor" aria-label="anchor" href="#arg-engine"></a></dt>
<dd><p>A single character string specifying what computational engine
to use for fitting. Can be <code>"xgboost"</code>, <code>"lightgbm"</code> (boosted trees) or
<code>"ranger"</code> (random forest). See the documentation below for more
information.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Used to pass additional engine-specific parameters to the model.
The parameters listed here can be tuned using <code><a href="tune_dw_model.html">tune_dw_model()</a></code>. All other
parameters must be fixed.</p><ul><li><p><code>alpha</code>: <code>&lt;xgboost&gt;</code> L1 regularization term on weights.</p></li>
<li><p><code>lambda</code>: <code>&lt;xgboost&gt;</code> L2 regularization term on weights.</p></li>
<li><p><code>num_leaves</code>: <code>&lt;lightgbm&gt;</code> max number of leaves in one tree.</p></li>
<li><p><code>regularization.factor</code>: <code>&lt;ranger&gt;</code> Regularization factor (gain penalization).</p></li>
<li><p><code>regularization.usedepth</code>: <code>&lt;ranger&gt;</code> Consider the depth in regularization? (<code>TRUE</code>/<code>FALSE</code>).</p></li>
<li><p><code>splitrule</code>: <code>&lt;ranger&gt;</code> Splitting rule. One of dials::ranger_reg_rules.</p></li>
<li><p><code>alpha</code>: <code>&lt;ranger&gt;</code> Significance threshold to allow splitting (for <code>splitrule = "maxstat"</code>).</p></li>
<li><p><code>minprop</code>: <code>&lt;ranger&gt;</code> Lower quantile of covariate distribution to be considered for splitting (for <code>splitrule = "maxstat"</code>).</p></li>
<li><p><code>num.random.splits</code>: <code>&lt;ranger&gt;</code> Number of random splits to consider for each candidate splitting variable (for <code>splitrule = "extratrees"</code>).</p></li>
</ul></dd>


<dt id="arg--date">.date<a class="anchor" aria-label="anchor" href="#arg--date"></a></dt>
<dd><p>The name of the 'date' column which defines the air quality
timeseries. Passed to <code><a href="append_dw_vars.html">append_dw_vars()</a></code> if needed. Also used to extract
the time zone of the data for later restoration if <code>trend</code> is used as a
variable.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>a 'Deweather' object for further analysis</p>
    </div>
    <div class="section level2">
    <h2 id="modelling-approaches-and-parameters">Modelling Approaches and Parameters<a class="anchor" aria-label="anchor" href="#modelling-approaches-and-parameters"></a></h2>


<div class="section">
<h3 id="types-of-model">Types of Model<a class="anchor" aria-label="anchor" href="#types-of-model"></a></h3>


<p>There are two modelling approaches available to <code>build_dw_model()</code>:</p><ul><li><p>Boosted Trees (<code>xgboost</code>, <code>lightgbm</code>)</p></li>
<li><p>Random Forest (<code>ranger</code>)</p></li>
</ul><p>Each of these approaches take different parameters.</p>
</div>

<div class="section">
<h3 id="boosted-trees">Boosted Trees<a class="anchor" aria-label="anchor" href="#boosted-trees"></a></h3>


<p>Two engines are available for boosted tree models:</p><ul><li><p><code>"xgboost"</code></p></li>
<li><p><code>"lightgbm"</code></p></li>
</ul><p>The following universal parameters apply and are tunable:</p><ul><li><p><code>tree_depth</code>: Tree Depth</p></li>
<li><p><code>trees</code>: # Trees</p></li>
<li><p><code>learn_rate</code>: Learning Rate</p></li>
<li><p><code>mtry</code>: # Randomly Selected Predictors</p></li>
<li><p><code>min_n</code>: Minimal Node Size</p></li>
<li><p><code>loss_reduction</code>: Minimum Loss Reduction</p></li>
<li><p><code>sample_size</code>: Proportion Observations Sampled (<code>xgboost</code> only)</p></li>
<li><p><code>stop_iter</code>: # Iterations Before Stopping (<code>xgboost</code> only)</p></li>
</ul><p>The following <code>xgboost</code>-specific parameters are tunable:</p><ul><li><p><code>alpha</code>: L1 regularization term on weights. Increasing this value will make model more conservative</p></li>
<li><p><code>lambda</code>: L2 regularization term on weights. Increasing this value will make model more conservative</p></li>
</ul><p>The following <code>lightgbm</code>-specific parameters are tunable:</p><ul><li><p><code>num_leaves</code>: max number of leaves in one tree</p></li>
</ul></div>

<div class="section">
<h3 id="random-forest">Random Forest<a class="anchor" aria-label="anchor" href="#random-forest"></a></h3>


<p>One engine is available for random forest models:</p><ul><li><p><code>"ranger"</code></p></li>
</ul><p>The following universal parameters apply and are tunable:</p><ul><li><p><code>mtry</code>: # Randomly Selected Predictors</p></li>
<li><p><code>trees</code>: # Trees</p></li>
<li><p><code>min_n</code>: Minimal Node Size</p></li>
</ul><p>The following <code>ranger</code>-specific parameters are tunable:</p><ul><li><p><code>regularization.factor</code>: Regularization factor (gain penalization)</p></li>
<li><p><code>regularization.usedepth</code>: Consider the depth in regularization? (<code>TRUE</code>/<code>FALSE</code>)</p></li>
<li><p><code>splitrule</code>: Splitting rule. One of dials::ranger_reg_rules</p></li>
<li><p><code>alpha</code>: Significance threshold to allow splitting (for <code>splitrule = "maxstat"</code>)</p></li>
<li><p><code>minprop</code>: Lower quantile of covariate distribution to be considered for splitting (for <code>splitrule = "maxstat"</code>)</p></li>
<li><p><code>num.random.splits</code>: Number of random splits to consider for each candidate splitting variable (for <code>splitrule = "extratrees"</code>)</p></li>
</ul></div>

    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="finalise_tdw_model.html">finalise_tdw_model()</a></code></p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Carslaw, Jack Davison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

