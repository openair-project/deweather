<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Meteorological Normalisation with {deweather} • deweather</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Nunito_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Meteorological Normalisation with {deweather}">
<meta name="description" content="Get started with deweather
">
<meta property="og:description" content="Get started with deweather
">
<meta property="og:image" content="https://openair-project.github.io/deweather/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">deweather</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.2.9104</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/deweather.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bookdown.org/david_carslaw/openair/" aria-label="Book"><span class="fa fa-book"></span> Book (External)</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openair-project/deweather/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Meteorological Normalisation with {deweather}</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openair-project/deweather/blob/main/vignettes/articles/deweather.Rmd" class="external-link"><code>vignettes/articles/deweather.Rmd</code></a></small>
      <div class="d-none name"><code>deweather.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Meteorology plays a central role in affecting the concentrations of
pollutants in the atmosphere. When considering trends in air pollutants
it can be very difficult to know whether a change in concentration is
due to emissions or meteorology.</p>
<p>The <strong>deweather</strong> package uses a powerful statistical
technique based on <em>boosted regression trees</em> using a variety of
packages using the <a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a> framework. This allows for
a variety of engines to be employed, with the default being
<a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a>. Statistical models are developed to explain
concentrations using meteorological and other variables. These models
can be tested on randomly withheld data with the aim of developing the
most appropriate model.</p>
<p>Much of <strong>deweather</strong> supports parallel processing with
the <a href="https://mirai.r-lib.org" class="external-link">mirai</a> package, so along with loading the library
we’ll set some daemons as well as a seed.</p>
</div>
<div class="section level2">
<h2 id="example-data-set">Example data set<a class="anchor" aria-label="anchor" href="#example-data-set"></a>
</h2>
<p>The <strong>deweather</strong> package comes with a comprehensive
data set of air quality and meteorological data. The air quality data is
from Marylebone Road in central London (obtained from the
<a href="https://openair-project.github.io/openair/" class="external-link">openair</a> package) and the meteorological data from
Heathrow Airport (obtained from the <a href="https://openair-project.github.io/worldmet/" class="external-link">worldmet</a> package).
The <code>aqroadside</code> data frame contains various pollutants such
a NO<sub>x</sub>, NO<sub>2</sub>, ethane and isoprene as well as
meteorological data including wind speed, wind direction, relative
humidity, ambient temperature and cloud cover.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aqroadside</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt;   date                  nox   no2 ethane isoprene benzene    ws    wd air_temp</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2000-01-01 <span style="color: #949494;">00:00:00</span>   388    78   13.5     1.22    7.74  2.1   200      7.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2000-01-01 <span style="color: #949494;">01:00:00</span>   886    84   12.0     0.85    5.66  2.1   190      7.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2000-01-01 <span style="color: #949494;">02:00:00</span>   816   117   14.7     1.75   11.4   1.8   211.     7.95</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2000-01-01 <span style="color: #949494;">03:00:00</span>   636    97   20.4     4.36   30.8   1.25  240      8.05</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2000-01-01 <span style="color: #949494;">04:00:00</span>   483    74   18.8     3.08   19.7   1.55  267.     8.6 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2000-01-01 <span style="color: #949494;">05:00:00</span>   231    65   16.4     2.12   13.1   2.35  269.     8.35</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: RH &lt;dbl&gt;, cl &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-for-model-building">Prepare for Model Building<a class="anchor" aria-label="anchor" href="#prepare-for-model-building"></a>
</h2>
<p>A straightforward way to get started is to use the
<code><a href="../reference/append_dw_vars.html">append_dw_vars()</a></code> function to attach a load of useful model
features to your air quality <code>data.frame</code>. Variables such as
the hour of the day (<code>"hour"</code>) and day of the week
(<code>"weekday"</code>) are used as features to explain some of the
variation. <code>"hour"</code> for example very usefully acts as a proxy
for the diurnal variation in emissions. These temporal emission proxies
are also important to include to help the model differentiate between
emission versus weather-related changes. For example, emissions tend to
change throughout a day and so do variables such as wind speed and
ambient temperature (here already present in the data as
<code>"ws"</code> and <code>"air_temp"</code> respectively).</p>
<p>Note that, strictly, <code><a href="../reference/append_dw_vars.html">append_dw_vars()</a></code> does not need to
be run directly; if <code><a href="../reference/build_dw_model.html">build_dw_model()</a></code> or
<code><a href="../reference/tune_dw_model.html">tune_dw_model()</a></code> are passed any of <code>"hour"</code>,
<code>"weekday"</code>, <code>"trend"</code>, <code>"yday"</code>,
<code>"week"</code>, or <code>"month"</code> to <code>vars</code>, the
parent function will use <code><a href="../reference/append_dw_vars.html">append_dw_vars()</a></code> itself in the
background if those columns do not exist in the input dataframe.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/append_dw_vars.html">append_dw_vars</a></span><span class="op">(</span><span class="va">aqroadside</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 149,040</span></span>
<span><span class="co">#&gt; Columns: 18</span></span>
<span><span class="co">#&gt; $ date     <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span> 2000-01-01 00:00:00<span style="color: #949494;">, </span>2000-01-01 01:00:00<span style="color: #949494;">, </span>2000-01-01 02:00:0…</span></span>
<span><span class="co">#&gt; $ nox      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 388<span style="color: #949494;">, </span>886<span style="color: #949494;">, </span>816<span style="color: #949494;">, </span>636<span style="color: #949494;">, </span>483<span style="color: #949494;">, </span>231<span style="color: #949494;">, </span>380<span style="color: #949494;">, </span>287<span style="color: #949494;">, </span>187<span style="color: #949494;">, </span>111<span style="color: #949494;">, </span>149<span style="color: #949494;">, </span>132<span style="color: #949494;">, </span>3…</span></span>
<span><span class="co">#&gt; $ no2      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 78<span style="color: #949494;">, </span>84<span style="color: #949494;">, </span>117<span style="color: #949494;">, </span>97<span style="color: #949494;">, </span>74<span style="color: #949494;">, </span>65<span style="color: #949494;">, </span>67<span style="color: #949494;">, </span>69<span style="color: #949494;">, </span>67<span style="color: #949494;">, </span>57<span style="color: #949494;">, </span>57<span style="color: #949494;">, </span>57<span style="color: #949494;">, </span>82<span style="color: #949494;">, </span>84<span style="color: #949494;">, </span>76<span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ ethane   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 13.54<span style="color: #949494;">, </span>11.99<span style="color: #949494;">, </span>14.69<span style="color: #949494;">, </span>20.38<span style="color: #949494;">, </span>18.75<span style="color: #949494;">, </span>16.38<span style="color: #949494;">, </span>16.16<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>…</span></span>
<span><span class="co">#&gt; $ isoprene <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.22<span style="color: #949494;">, </span>0.85<span style="color: #949494;">, </span>1.75<span style="color: #949494;">, </span>4.36<span style="color: #949494;">, </span>3.08<span style="color: #949494;">, </span>2.12<span style="color: #949494;">, </span>1.25<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span>0.4…</span></span>
<span><span class="co">#&gt; $ benzene  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 7.74<span style="color: #949494;">, </span>5.66<span style="color: #949494;">, </span>11.38<span style="color: #949494;">, </span>30.75<span style="color: #949494;">, </span>19.66<span style="color: #949494;">, </span>13.13<span style="color: #949494;">, </span>7.64<span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">, </span><span style="color: #BB0000;">NA</span><span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ ws       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.10<span style="color: #949494;">, </span>2.10<span style="color: #949494;">, </span>1.80<span style="color: #949494;">, </span>1.25<span style="color: #949494;">, </span>1.55<span style="color: #949494;">, </span>2.35<span style="color: #949494;">, </span>1.80<span style="color: #949494;">, </span>1.00<span style="color: #949494;">, </span>0.50<span style="color: #949494;">, </span>0.00<span style="color: #949494;">, </span>0…</span></span>
<span><span class="co">#&gt; $ wd       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 200.0000<span style="color: #949494;">, </span>190.0000<span style="color: #949494;">, </span>210.5560<span style="color: #949494;">, </span>240.0000<span style="color: #949494;">, </span>267.3591<span style="color: #949494;">, </span>268.9254<span style="color: #949494;">, </span>2…</span></span>
<span><span class="co">#&gt; $ air_temp <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 7.400000<span style="color: #949494;">, </span>7.833333<span style="color: #949494;">, </span>7.950000<span style="color: #949494;">, </span>8.050000<span style="color: #949494;">, </span>8.600000<span style="color: #949494;">, </span>8.350000<span style="color: #949494;">, </span>8…</span></span>
<span><span class="co">#&gt; $ RH       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 97.33482<span style="color: #949494;">, </span>97.15970<span style="color: #949494;">, </span>99.00136<span style="color: #949494;">, </span>98.67437<span style="color: #949494;">, </span>95.11393<span style="color: #949494;">, </span>97.71058<span style="color: #949494;">, </span>9…</span></span>
<span><span class="co">#&gt; $ cl       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5.0<span style="color: #949494;">, </span>6.0<span style="color: #949494;">, </span>4.5<span style="color: #949494;">, </span>4.5<span style="color: #949494;">, </span>7.5<span style="color: #949494;">, </span>5.5<span style="color: #949494;">, </span>8.0<span style="color: #949494;">, </span>4.0<span style="color: #949494;">, </span>1.5<span style="color: #949494;">, </span>2.5<span style="color: #949494;">, </span>4.0<span style="color: #949494;">, </span>7.0<span style="color: #949494;">, </span>4…</span></span>
<span><span class="co">#&gt; $ trend    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 946684800<span style="color: #949494;">, </span>946688400<span style="color: #949494;">, </span>946692000<span style="color: #949494;">, </span>946695600<span style="color: #949494;">, </span>946699200<span style="color: #949494;">, </span>946702…</span></span>
<span><span class="co">#&gt; $ hour     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>2<span style="color: #949494;">, </span>3<span style="color: #949494;">, </span>4<span style="color: #949494;">, </span>5<span style="color: #949494;">, </span>6<span style="color: #949494;">, </span>7<span style="color: #949494;">, </span>8<span style="color: #949494;">, </span>9<span style="color: #949494;">, </span>10<span style="color: #949494;">, </span>11<span style="color: #949494;">, </span>12<span style="color: #949494;">, </span>13<span style="color: #949494;">, </span>14<span style="color: #949494;">, </span>15<span style="color: #949494;">, </span>16<span style="color: #949494;">, </span>17<span style="color: #949494;">,</span>…</span></span>
<span><span class="co">#&gt; $ weekday  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>Sat<span style="color: #949494;">, </span>S…</span></span>
<span><span class="co">#&gt; $ weekend  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> weekend<span style="color: #949494;">, </span>weekend<span style="color: #949494;">, </span>weekend<span style="color: #949494;">, </span>weekend<span style="color: #949494;">, </span>weekend<span style="color: #949494;">, </span>weekend<span style="color: #949494;">, </span>weekend…</span></span>
<span><span class="co">#&gt; $ yday     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ week     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ month    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>Jan<span style="color: #949494;">, </span>J…</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-a-model">Build a Model<a class="anchor" aria-label="anchor" href="#build-a-model"></a>
</h2>
<div class="section level3">
<h3 id="tuning-a-model">Tuning a Model<a class="anchor" aria-label="anchor" href="#tuning-a-model"></a>
</h3>
<p>There are many input parameters to <code><a href="../reference/build_dw_model.html">build_dw_model()</a></code> and,
while sensible defaults have been set, you may be interested in seeing
how tweaking them can influence how well the model behaves. This is
called “tuning”, and the <code><a href="../reference/tune_dw_model.html">tune_dw_model()</a></code> function provides
an interface for this. Any of the boosted decision tree parameters
(e.g., <code>tree_depth</code> and <code>trees</code>) can be set as a
range which is then combined with <code>grid_levels</code> to create a
regular grid of all parameter combinations.</p>
<p>Note that this process can take a while, especially if many
parameters are being tuned. One way to speed this up is to invoke
parallel processing through the <code>mirai</code> package - see <a href="https://tune.tidymodels.org/articles/extras/optimizations.html#parallel-processing" class="external-link uri">https://tune.tidymodels.org/articles/extras/optimizations.html#parallel-processing</a>
for more information. In this example, we’ll also significantly trim
down the data to speed things up.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tuned_results</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">aqroadside</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># want to sample by weekday to get good spread of categorical data</span></span>
<span>  <span class="fu"><a href="../reference/append_dw_vars.html">append_dw_vars</a></span><span class="op">(</span><span class="st">"weekday"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">250</span>, by <span class="op">=</span> <span class="va">weekday</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># tune model</span></span>
<span>  <span class="fu"><a href="../reference/tune_dw_model.html">tune_dw_model</a></span><span class="op">(</span></span>
<span>    pollutant <span class="op">=</span> <span class="st">"no2"</span>,</span>
<span>    tree_depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    trees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">250</span><span class="op">)</span>,</span>
<span>    grid_levels <span class="op">=</span> <span class="fl">3L</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; → <span style="color: #BBBB00; font-weight: bold;">A</span> | <span style="color: #BBBB00;">warning</span>: `early_stop` was reduced to 149.</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BBBB00; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; There were issues with some computations   <span style="color: #BBBB00; font-weight: bold;">A</span>: x1</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>This output has a few useful features. First, we’re informed that the
best value for <code>trees</code> is 150 and for <code>tree_depth</code>
is 5.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tuned_results</span><span class="op">$</span><span class="va">best_params</span></span>
<span><span class="co">#&gt; $trees</span></span>
<span><span class="co">#&gt; [1] 150</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tree_depth</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>We can also see how the tuned model behaved on some reserved testing
data. A table of predictions is returned, as well as a table of
statistics and a scatter plot of modelled vs measured values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">tuned_results</span><span class="op">$</span><span class="va">final_fit</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 1</span></span>
<span><span class="co">#&gt; Columns: 12</span></span>
<span><span class="co">#&gt; $ pollutant <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> no2</span></span>
<span><span class="co">#&gt; $ n         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 424</span></span>
<span><span class="co">#&gt; $ fac2      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9811321</span></span>
<span><span class="co">#&gt; $ mb        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.036324</span></span>
<span><span class="co">#&gt; $ mge       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 18.71052</span></span>
<span><span class="co">#&gt; $ nmb       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.0108988</span></span>
<span><span class="co">#&gt; $ nmge      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.1967747</span></span>
<span><span class="co">#&gt; $ rmse      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 25.25123</span></span>
<span><span class="co">#&gt; $ r         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.8481663</span></span>
<span><span class="co">#&gt; $ p         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.626224e-118</span></span>
<span><span class="co">#&gt; $ coe       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.5046585</span></span>
<span><span class="co">#&gt; $ ioa       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.7523293</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tuned_results</span><span class="op">$</span><span class="va">final_fit</span><span class="op">$</span><span class="va">plot</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/finalplot-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="finalising-a-model">Finalising a Model<a class="anchor" aria-label="anchor" href="#finalising-a-model"></a>
</h3>
<p>Assuming that a good model can be developed, it can now be explored
in more detail. <code>deweather</code> has useful defaults for many of
the model parameters, but these can be adjusted by the user if
required.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">no2_model</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/build_dw_model.html">build_dw_model</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">aqroadside</span>,</span>
<span>    pollutant <span class="op">=</span> <span class="st">"no2"</span>,</span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"hour"</span>, <span class="st">"weekday"</span>, <span class="st">"air_temp"</span><span class="op">)</span>,</span>
<span>    engine <span class="op">=</span> <span class="st">"xgboost"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This function returns a “deweathering model” object. We can see a
quick summary of it by simply printing it.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">no2_model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Deweather Model</span> <span style="color: #00BBBB;">─────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> A model for predicting <span style="font-weight: bold;">no2</span> using <span style="color: #00BB00;">wd (45%)</span>, <span style="color: #00BB00;">hour (26.5%)</span>, <span style="color: #00BB00;">trend (12%)</span>, <span style="color: #00BB00;">weekday</span></span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">(7.6%)</span>, <span style="color: #00BB00;">ws (6.4%)</span>, and <span style="color: #00BB00;">air_temp (2.4%)</span>.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Model Parameters</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">tree_depth</span>: 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">trees</span>: 200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">learn_rate</span>: 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">mtry</span>: NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">min_n</span>: 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">loss_reduction</span>: 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">sample_size</span>: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • <span style="color: #00BB00;">stop_iter</span>: 190</span></span></code></pre></div>
<p>We can also pull out specific features of the model using
<code>get_dw_*()</code> functions. <a href="https://openair-project.github.io/deweather/">deweather</a> has many of
such ‘getter’ functions, and they form a consistent, useful API for
accessing relevant features of different objects created in the
package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getters-dw.html">get_dw_pollutant</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "no2"</span></span>
<span><span class="fu"><a href="../reference/getters-dw.html">get_dw_vars</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "trend"    "ws"       "wd"       "hour"     "weekday"  "air_temp"</span></span>
<span><span class="fu"><a href="../reference/getters-dw.html">get_dw_input_data</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 144,535 × 7</span></span></span>
<span><span class="co">#&gt;      no2     trend    ws    wd  hour weekday air_temp</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    78 946<span style="text-decoration: underline;">684</span>800  2.1   200      0 Sat         7.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    84 946<span style="text-decoration: underline;">688</span>400  2.1   190      1 Sat         7.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   117 946<span style="text-decoration: underline;">692</span>000  1.8   211.     2 Sat         7.95</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    97 946<span style="text-decoration: underline;">695</span>600  1.25  240      3 Sat         8.05</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    74 946<span style="text-decoration: underline;">699</span>200  1.55  267.     4 Sat         8.6 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    65 946<span style="text-decoration: underline;">702</span>800  2.35  269.     5 Sat         8.35</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    67 946<span style="text-decoration: underline;">706</span>400  1.8   260      6 Sat         8.2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    69 946<span style="text-decoration: underline;">710</span>000  1     250      7 Sat         7.1 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    67 946<span style="text-decoration: underline;">713</span>600  0.5   240      8 Sat         6.2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    57 946<span style="text-decoration: underline;">720</span>800  0.5   210     10 Sat         6.9 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 144,525 more rows</span></span></span></code></pre></div>
<p>One feature we immediately have access to is the “feature importance”
score. This can be obtained as a <code>data.frame</code> using a similar
approach to the above. This varies depending on the chosen
<code>engine</code>, but for boosted trees this represents ‘Gain’ - the
fractional contribution of each feature to the model based on the total
gain of this feature’s splits. A higher percentage means a more
important predictive feature.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getters-dw.html">get_dw_importance</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 2</span></span></span>
<span><span class="co">#&gt;    var        importance</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> wd           0.450   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> hour         0.265   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> trend        0.120   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> ws           0.064<span style="text-decoration: underline;">5</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> weekdaySun   0.042<span style="text-decoration: underline;">7</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> weekdaySat   0.027<span style="text-decoration: underline;">2</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> air_temp     0.024<span style="text-decoration: underline;">4</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> weekdayMon   0.003<span style="text-decoration: underline;">00</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> weekdayThu   0.001<span style="text-decoration: underline;">56</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> weekdayWed   0.001<span style="text-decoration: underline;">08</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> weekdayFri   0.000<span style="text-decoration: underline;">332</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> weekdayTue   0.000<span style="text-decoration: underline;">294</span></span></span></code></pre></div>
<p>The Gain can be automatically plotted as a bar chart using the
<code><a href="../reference/plot_dw_importance.html">plot_dw_importance()</a></code> function. The wind direction is the
most predictive feature, and the day of the week being any week day is
the least predictive feature.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_importance.html">plot_dw_importance</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/fig-plotimport-1.png" class="r-plt" alt="The feature importance of our model." width="700"><p class="caption">
The feature importance of our model.
</p>
</div>
<p>You’ll notice that our ‘character’ variable, the day of the week, has
been split out into multiple levels. This is because
<a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a> requires numeric variables, so behind the scenes
our ‘day of the week’ variable is split out into a matrix of seven
variables. This is informative - for example, we can see here that the
day of the week being a weekend is a useful feature. Regardless, if you
would like to see factor features as single features, the
<code>aggregate_factors</code> argument may be of use.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_importance.html">plot_dw_importance</a></span><span class="op">(</span><span class="va">no2_model</span>, aggregate_factors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/fig-plotimportagg-1.png" class="r-plt" alt="The feature importance of our model, with factors aggregated." width="700"><p class="caption">
The feature importance of our model, with factors aggregated.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="examine-the-partial-dependencies">Examine the partial dependencies<a class="anchor" aria-label="anchor" href="#examine-the-partial-dependencies"></a>
</h2>
<div class="section level3">
<h3 id="basic-pd-plots">Basic PD Plots<a class="anchor" aria-label="anchor" href="#basic-pd-plots"></a>
</h3>
<p>One of the benefits of the boosted regression tree approach is that
the <em>partial dependencies</em> can be explored. In simple terms, the
partial dependencies show the relationship between the pollutant of
interest and the covariates used in the model while holding the value of
other covariates at their mean level.</p>
<p>Lets plot a partial dependency for the <code>hour</code> variable.
We’ll set <code>n</code> to <code>100</code> for speed; this will sample
100 random samples of our original data to construct the plot. We can
see that <code>no2</code> is highest during the day and lowest
overnight, everything else kept equal.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"hour"</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd1d-1.png" class="r-plt" width="700"></p>
<p>A categorical variable like <code>weekday</code> looks slightly
different, but achieves a similar result. <code>no2</code> is lowest on
weekends, all else being equal.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"weekday"</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd1d2-1.png" class="r-plt" width="700"></p>
<p>If a variable isn’t given, all variables will be plotted in a
<code>patchwork</code> assembly in order of importance.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd1d3-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="grouped-pd">Grouped PD<a class="anchor" aria-label="anchor" href="#grouped-pd"></a>
</h3>
<p>Sometimes, when examining partial dependences, it is useful to
consider <em>grouped</em> partial dependences. This means, before PDs
are calculated, we split the data into groups and calculate PDs for each
subset of the data. Let’s give this a go now.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"hour"</span>, group <span class="op">=</span> <span class="st">"weekday"</span>, n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/calcPDWkday-1.png" class="r-plt" width="700"></p>
<p>Note that <code>group</code> need not be categorical; you may provide
a continuous variable which will be binned into
<code>group_intervals</code>. Here we group by <code>"air_temp"</code>
and split it into 3 equally sized bins.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span></span>
<span>  <span class="va">no2_model</span>,</span>
<span>  <span class="st">"hour"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"air_temp"</span>,</span>
<span>  group_intervals <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/calcPDWkday2-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="two-way-interactions">Two-Way Interactions<a class="anchor" aria-label="anchor" href="#two-way-interactions"></a>
</h3>
<p>Above we needed to treat one of our continuous features as a factor
feature.</p>
<p>It can be very useful to plot important two-way interactions. In this
example the interaction between <code>"ws"</code> and
<code>"air_temp"</code> is considered. The plot shows that
<code>no2</code> tends to be high when the wind speed is low and the
temperature is low, i.e., stable atmospheric conditions. Also
<code>no2</code> tends to be high when the temperature is high, which is
most likely due to more O<sub>3</sub> available to convert NO to
NO<sub>2</sub>. In fact, background O<sub>3</sub> would probably be a
useful covariate to add to the model.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_2d.html">plot_dw_partial_2d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"ws"</span>, <span class="st">"air_temp"</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd2d1-1.png" class="r-plt" width="700"></p>
<p>It can be easier to see some of these relationships using a binned
scale. <code>contour = "lines"</code> will overlay the continuous colour
surface with contour lines. <code>contour = "fill"</code> will bin the
entire colour scale. The number of bins is controlled using the
<code>contour_bins</code> argument.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_2d.html">plot_dw_partial_2d</a></span><span class="op">(</span></span>
<span>  <span class="va">no2_model</span>,</span>
<span>  <span class="st">"ws"</span>,</span>
<span>  <span class="st">"air_temp"</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  contour <span class="op">=</span> <span class="st">"fill"</span>,</span>
<span>  contour_bins <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  cols <span class="op">=</span> <span class="st">"turbo"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd2d2-1.png" class="r-plt" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="customisation">Customisation<a class="anchor" aria-label="anchor" href="#customisation"></a>
</h2>
<p>These plots can be customised like any other <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a>
object.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"hour"</span>,group <span class="op">=</span> <span class="st">"weekday"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"plain"</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"orange"</span>,</span>
<span>      <span class="st">"cadetblue"</span>,</span>
<span>      <span class="st">"lightblue4"</span>,</span>
<span>      <span class="st">"lightblue3"</span>,</span>
<span>      <span class="st">"lightblue2"</span>,</span>
<span>      <span class="st">"lightblue1"</span>,</span>
<span>      <span class="st">"orange3"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Hour of the Day"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"NOx (ug/m3)"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Weekday"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Weekday"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Weekends (orange) have lower NOx emissions than weekdays (blue)."</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">24</span>, <span class="fl">4</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">x</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/fig-ggplot-1.png" class="r-plt" alt="A thoroughly customised partial dependence plot." width="700"><p class="caption">
A thoroughly customised partial dependence plot.
</p>
</div>
</div>
<div class="section level2">
<h2 id="apply-meteorological-averaging">Apply meteorological averaging<a class="anchor" aria-label="anchor" href="#apply-meteorological-averaging"></a>
</h2>
<p>An <em>indication</em> of the meteorologically-averaged trend is
given by the <code><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d()</a></code> function above.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span><span class="va">no2_model</span>, <span class="st">"trend"</span>, n <span class="op">=</span> <span class="fl">100</span>, intervals <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/pd-trend-1.png" class="r-plt" width="672"></p>
<p>A much better indication is given by using the model to predict many
times with random sampling of <strong>meteorological</strong>
conditions. This sampling is carried out by the
<code>simulate_met()</code> function.</p>
<p>Note that you’d typically want <code>n</code> to be a higher value
than what’s used in this example; it has been set to <code>50</code> for
speed. Recall also that some <code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">mirai::daemons()</a></code> are set to
allow for parallelism.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_dw_met.html">simulate_dw_met</a></span><span class="op">(</span></span>
<span>  <span class="va">no2_model</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"air_temp"</span><span class="op">)</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now it is possible to plot the resulting trend.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">demet</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">no2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://openair-project.github.io/openair/reference/quickText.html" class="external-link">quickText</a></span><span class="op">(</span><span class="st">"NO2"</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plotTrend-1.png" class="r-plt" alt="A line chart with date on the x-axis and deweathered NO2 on the y-axis. The trend is very noisy, but shows an increase in concentrations in 2003." width="672"><p class="caption">
A deweathered nitrogen dioxide trend.
</p>
</div>
<p>The plot shows the trend in NO<sub>2</sub> controlling for the main
weather variables. The plot now reveals the strong diurnal and weekly
cycle in NO<sub>2</sub> that is driven by variations in the sources of
NO<sub>2</sub> (NO<sub>x</sub>) rather than meteorology, i.e., road
traffic which has strong hourly and daily variations throughout the
year. It can be useful to simply average the results to provide a better
indication of the overall trend. For example:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demet</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://openair-project.github.io/openair/reference/timeAverage.html" class="external-link">timeAverage</a></span><span class="op">(</span><span class="st">"month"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">no2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://openair-project.github.io/openair/reference/quickText.html" class="external-link">quickText</a></span><span class="op">(</span><span class="st">"NO2"</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plotTrendAve-1.png" class="r-plt" alt="A line chart with date on the x-axis and deweathered NO2 on the y-axis. The trend has been time averaged to show monthly mean concentrations, clearly illustrating a sharp increase in 2003." width="672"><p class="caption">
A time-averaged deweathered nitrogen dioxide trend.
</p>
</div>
<p>With some simple data manipulation, we can compare the meteorological
simulation, the partial dependence profile, and the input data. It is
clear that the input data has much more noise. The PD profile are
simulated data are similar, but the simulated data are higher overall.
This highlights that purely relying on the PD profiles (which isolates
the trend from even temporal variables like day of the week) may
underestimate pollutant concentrations.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PD - set intervals to something high for a good profile</span></span>
<span><span class="va">pd_trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_dw_partial_1d.html">plot_dw_partial_1d</a></span><span class="op">(</span></span>
<span>  <span class="va">no2_model</span>,</span>
<span>  <span class="st">"trend"</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  intervals <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="st">"trend"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">trend</span><span class="op">)</span>,</span>
<span>    no2 <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># input data</span></span>
<span><span class="va">input_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getters-dw.html">get_dw_input_data</a></span><span class="op">(</span><span class="va">no2_model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">trend</span><span class="op">)</span>,</span>
<span>    no2 <span class="op">=</span> <span class="va">no2</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># combine with demet and plot</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="st">"Simulated"</span> <span class="op">=</span> <span class="va">demet</span>,</span>
<span>  <span class="st">"Input"</span> <span class="op">=</span> <span class="va">input_data</span>,</span>
<span>  <span class="st">"Partial Dep"</span> <span class="op">=</span> <span class="va">pd_trend</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"source"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://openair-project.github.io/openair/reference/timeAverage.html" class="external-link">timeAverage</a></span><span class="op">(</span><span class="st">"month"</span>, type <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">no2</span>, color <span class="op">=</span> <span class="va">source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://openair-project.github.io/openair/reference/quickText.html" class="external-link">quickText</a></span><span class="op">(</span><span class="st">"NO2"</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Input"</span> <span class="op">=</span> <span class="st">"grey70"</span>,</span>
<span>      <span class="st">"Partial Dep"</span> <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>      <span class="st">"Simulated"</span> <span class="op">=</span> <span class="st">"royalblue"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="deweather_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" width="700"></p>
<p>Note that the function <code><a href="../reference/predict_dw.html">predict_dw()</a></code> is also provided for
generalised use of a deweather model for prediction.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Carslaw, Jack Davison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
